<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sing-a-Song Challenge (Participant)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .screen { transition: opacity 0.5s ease-in-out; }
        .hidden { display: none; }
        .passage-box {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: left;
            max-width: 48rem;
            margin: 1rem auto;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div id="main-content" class="w-full">
        <div id="app-container" class="bg-white p-4 sm:p-8 rounded-2xl shadow-2xl max-w-5xl w-full text-center relative transition-all duration-500 mx-auto">
            
            <div id="sessionIdContainer" class="absolute bottom-4 left-4 bg-indigo-100 text-indigo-800 text-sm font-semibold px-4 py-2 rounded-lg shadow-md hidden">
                Session ID: <span id="sessionIdDisplay" class="font-bold"></span>
            </div>

            <!-- Screen: Welcome -->
            <div id="welcome" class="screen">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800 mb-4">BETA Pilot Study Stress Challenge</h1>
                    <p class="text-gray-600 mb-8 text-lg">Please wait for the researcher to begin the session.</p>
                </div>
            </div>

            <!-- Screen: Pre-Baseline Survey -->
            <div id="preBaselineSurvey" class="screen hidden">
                <div class="max-w-4xl mx-auto text-left space-y-4">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Log Your Stress Level</h2>
                    <p>Please open the <strong>MyT1Diabetes</strong> app and open the <strong>I’ve Noticed</strong> feature.</p>
                    <p>Select ‘Write a note’, tap the text box and enter: <code class="bg-gray-200 text-red-600 p-1 rounded">Stress 0=[your response to the survey below]</code>. After you’ve entered your response, please select ‘Confirm’.</p>
                    <div class="my-4 p-4 border rounded-lg bg-gray-50">
                        <p class="font-bold">What is your current stress level?</p>
                        <ul class="list-none space-y-1 mt-2">
                            <li>○ 😰 Very stressed</li>
                            <li>○ 😨 Stressed</li>
                            <li>○ 😥 Somewhat stressed</li>
                            <li>○ 😶 Neutral</li>
                            <li>○ 😌 Not stressed at all</li>
                            <li>○ ⚪️ No answer</li>
                        </ul>
                    </div>
                    <p class="text-center font-semibold text-indigo-600 mt-4">Waiting for the researcher to continue...</p>
                </div>
            </div>

            <!-- Screen: Resting Baseline -->
            <div id="baseline" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Resting Baseline</h2>
                    <p class="text-gray-600 mb-6">Please sit quietly and try to relax. The researcher will start the timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="baselineTimer">3:00</div>
                </div>
            </div>
            
            <!-- Screen: Task Introduction -->
            <div id="taskIntroduction" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Instructions</h2>
                    <p class="text-gray-600 mb-6">Please listen to the researcher for instructions.</p>
                    <p class="text-center font-semibold text-indigo-600 mt-4">Waiting for the researcher to continue...</p>
                </div>
            </div>

            <!-- Screen: Generic Countdown -->
            <div id="countdown" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Countdown</h2>
                    <p class="text-gray-600 mb-6">Please remain seated and wait quietly.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="countdownTimer">1:00</div>
                </div>
            </div>

            <!-- Screen: Silent Reading -->
            <div id="silentReading" class="screen hidden"></div>

            <!-- Screen: Read Aloud -->
            <div id="readAloud" class="screen hidden"></div>
            
            <!-- Screen: Read Aloud Challenge Instructions -->
            <div id="challengeInstructions" class="screen hidden"></div>
            
            <!-- Screen: Sing a Song -->
            <div id="singASong" class="screen hidden"></div>

            <!-- Screen: Post-Task Survey -->
            <div id="postTaskSurvey" class="screen hidden">
                 <div class="max-w-4xl mx-auto text-left space-y-4">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">Log Your Stress Level</h2>
                    <p>Please open the <strong>MyT1Diabetes</strong> app and open the <strong>I’ve Noticed</strong> feature.</p>
                    <p>Select ‘Write a note’, tap the text box and enter: <code class="bg-gray-200 text-red-600 p-1 rounded">Stress 1=[your response to the survey below]</code>. After you’ve entered your response, please select ‘Confirm’.</p>
                    <div class="my-4 p-4 border rounded-lg bg-gray-50">
                        <p class="font-bold">What is your current stress level?</p>
                        <ul class="list-none space-y-1 mt-2">
                            <li>○ 😰 Very stressed</li>
                            <li>○ 😨 Stressed</li>
                            <li>○ 😥 Somewhat stressed</li>
                            <li>○ 😶 Neutral</li>
                            <li>○ 😌 Not stressed at all</li>
                            <li>○ ⚪️ No answer</li>
                        </ul>
                    </div>
                    <p class="text-center font-semibold text-indigo-600 mt-4">Waiting for the researcher to continue...</p>
                </div>
            </div>

            <!-- Screen: Meal -->
            <div id="meal" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4">Meal Time</h2>
                    <p class="text-gray-600 mb-6">Please consume the provided liquid meal. The researcher will start the 5-minute timer.</p>
                    <div class="text-8xl font-mono font-bold my-4 text-gray-800" id="mealTimer">5:00</div>
                </div>
            </div>

            <!-- Screen: Complete -->
            <div id="complete" class="screen hidden">
                <div class="max-w-4xl mx-auto">
                    <h1 class="text-5xl font-extrabold text-green-600 mb-4">Challenge Complete</h1>
                    <div class="text-gray-700 text-lg mb-4 bg-indigo-50 p-6 rounded-lg">
                        <p>Thank you for your participation. Please remember to avoid food, beverages (other than water), and strenuous or stressful activity until:</p>
                        <p id="endTimeDisplay" class="text-4xl font-bold text-indigo-600 my-4"></p>
                    </div>
                    <p class="text-gray-600">You may now close this page.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        let db, auth;
        let sessionId = null;
        let gameState = {};
        let mainTimer = null;
        let remainingSeconds = 0;
        let lastCommandId = null;
        let sessionStartTime = null;
        let heartbeatInterval = null;
        let allConfigs = {}; 

        const screenConfig = {
            'baseline': { timerId: 'baselineTimer', duration: 180 },
            'countdown': { timerId: 'countdownTimer', duration: 60 },
            'silentReading': { timerId: 'taskTimer', duration: 12 },
            'readAloud': { timerId: 'taskTimer', duration: 12 },
            'challengeInstructions': { timerId: 'taskTimer', duration: 60 },
            'singASong': { timerId: 'taskTimer', duration: 60 },
            'meal': { timerId: 'mealTimer', duration: 300 },
        };

        function initializeContent() {
             allConfigs = {
                'silentReading': { taskContent: { title: 'Read the following passage Silently', passageTitle: 'Vacuum Cleaner', passageBody: 'A vacuum cleaner, also known simply as a vacuum, is a device that uses suction-often with agitation-to remove dirt and debris from carpets, hard floors, and other surfaces. The dirt is collected into a dust bag or plastic bin. Vacuum cleaners come in many forms, including stick, handheld, upright, canister, and specialized shop vacuums that can handle both solids and liquids.\n\nAlthough vacuum cleaner and vacuum are neutral terms, in some countries (e.g., the UK and Ireland) hoover is used generically (and as a verb) after the Hoover Company, one of the earliest producers of the device. In parts of New Zealand it\'s sometimes called a lux. The term sweeper may also be used, though it can refer specifically to a carpet sweeper.\n\nThe first manual vacuum designs using bellows appeared in the 1860s; motorized versions followed at the turn of the 20th century, leading to rapid innovation during that decade.'}},
                'readAloud1_content': { taskContent: { title: 'Read the following passage Aloud', passageTitle: 'Paper Clip', passageBody: 'A paper clip (or paperclip) is a small steel-wire device (sometimes plastic-coated) bent into loops that hold sheets of paper together by torsion and friction. Most modern clips are based on the Gem type introduced in the 1890s, characterized by one-and-a-half loops.\n\nPaper clips have an oblong shape with straight sides, though triangular, circular, and novelty shapes exist. Alternatives include two-piece clamping systems and spring-fastened binder clips. Their simplicity and versatility have made them ubiquitous in offices, schools, and creative projects. A typical metal paper clip weighs about one gram.'}},
                'readAloud2_content': { taskContent: { title: 'Read the following passage Aloud', passageTitle: 'Wood', passageBody: 'Wood is the structural xylem tissue in the stems and roots of trees and other woody plants-a composite of cellulose fibers (strong under tension) embedded in lignin (resistant to compression). In living trees it provides support and transports water and nutrients.\n\nHumans have used wood for millennia as fuel, construction material, and for tools, weapons, furniture, paper, and, more recently, purified cellulose products such as cellophane. As of 2020, global forest growing stock totaled roughly 557 billion m³, with nearly 4 billion m³ harvested annually (dominantly for construction and furniture). Wood science has been an established field since the early 20th century.'}},
                'challengeInstructions': { taskContent: { title: 'Read the following Challenge instructions Aloud', passageTitle: '', passageBody: 'You will now prepare for a singing challenge. Your performance will be recorded and evaluated by a music professional. Songs you may be asked to sing are listed below. If you finish a song before the time ends. Start over from the beginning until the timer reaches 00:00.\n\nOnce you see the screen with lyrics to the song, begin singing!\n\nSong list:\n• I\'m a Little Teapot\n• Twinkle, Twinkle, Little Star\n• Mary Had a Little Lamb'}},
                'singASong1_content': { taskContent: { title: 'Sing the following song Aloud', passageTitle: 'I\'m a Little Teapot', passageBody: 'Verse 1\nI\'m a little teapot, short and stout. Here is my handle, here is my spout. When the water\'s boiling, hear me shout: "Tip me over, pour me out!"\n\nVerse 2\nI\'m a little teapot, short and stout. Here is my handle, here is my spout. I can change my handle or my spout-"Tip me over, pour me out!"\n\nVerse 3\nI\'m a little teapot, short and stout. Here is my handle, here is my spout. When the water\'s boiling, hear me shout: "Tip me over, pour me out!"\n\nVerse 4\nI\'m a little teapot, short and stout. Here is my handle, here is my spout. I can change my handle or my spout - "Tip me over, pour me out!"'}},
                'singASong2_content': { taskContent: { title: 'Sing the following song Aloud', passageTitle: 'Twinkle, Twinkle, Little Star', passageBody: 'Twinkle, twinkle, little star, How I wonder what you are!\n\nUp above the world so high, Like a diamond in the sky.\n\n\nWhen the blazing sun is set, And the grass with dew is wet,\n\nThen you show your little light-Twinkle, twinkle, all the night.\n\n\nThen the traveler in the dark. Thanks you for your tiny spark;\n\nHe could not see which way to go. If you did not twinkle so.\n\n\nAs your bright and tiny spark. Lights the traveler in the dark-\n\nThough I know not what you are, Twinkle, twinkle, little star.'}},
                'singASong3_content': { taskContent: { title: 'Sing the following song Aloud', passageTitle: 'Mary Had a Little Lamb', passageBody: 'Verse 1:\nMary had a little lamb, little lamb, little lamb; Mary had a little lamb, its fleece was white as snow.\n\nVerse 2:\nAnd everywhere that Mary went, Mary went, Mary went; and everywhere that Mary went, the lamb was sure to go.\n\nVerse 3:\nIt followed her to school one day, school one day, school one day; it followed her to school one day, which was against the rule.\n\nVerse 4:\nIt made the children laugh and play, laugh and play, laugh and play; it made the children laugh and play to see the lamb at school.\n\nVerse 5:\nAnd so the teacher sent it out, sent it out, sent it out; and so the teacher sent it out, but still it lingered near.\n\nVerse 6:\nIt stood and waited round about, round about, round about; it stood and waited round about, till Mary did appear.\n\nVerse 7:\n"Why does the lamb love Mary so?" the little children cry.'}}
            };
        }

        window.onload = function() {
            initializeContent();
            const firebaseConfig = {
                apiKey: "AIzaSyDU_9f8mWWP6GHcJzW0BnzsmYUCvIBXooU",
                authDomain: "sing-a-song-c80f1.firebaseapp.com",
                projectId: "sing-a-song-c80f1",
                storageBucket: "sing-a-song-c80f1.firebasestorage.app",
                messagingSenderId: "542681033418",
                appId: "1:542681033418:web:6bc5b4e8ecca456233"
            };

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error');
                signIn();
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                document.getElementById('main-content').innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl"><h1 class="text-2xl font-bold text-red-600">Error: Could not connect to the server.</h1></div>`;
            }
        };

        async function signIn() {
            try {
                await signInAnonymously(auth);
                initializeSession();
            } catch (error) {
                console.error("Authentication Error", error);
                document.getElementById('main-content').innerHTML = `<h1>Authentication Failed</h1><p>${error.message}</p>`;
            }
        }

        function startHeartbeat() {
            stopHeartbeat();
            heartbeatInterval = setInterval(() => {
                if (sessionId) {
                    updateGameState({ participantHeartbeat: serverTimestamp() });
                }
            }, 30000);
        }

        function stopHeartbeat() {
            clearInterval(heartbeatInterval);
        }

        function initializeSession() {
            sessionStartTime = new Date();
            sessionId = generateSessionId();
            document.getElementById('sessionIdDisplay').textContent = sessionId;
            document.getElementById('sessionIdContainer').classList.remove('hidden');
            const userId = auth.currentUser?.uid || 'anonymous';
            const appId = "sing-a-song-c80f1"; 
            
            const timezoneOffset = new Date().getTimezoneOffset();
            
            gameState = {
                screenId: 'welcome',
                sessionId: sessionId,
                participantId: userId,
                appId: appId,
                timezoneOffset: timezoneOffset,
                timer: { running: false, value: '0:00' },
                taskContent: {}
            };
            updateGameState(gameState);
            listenForCommands();
            startHeartbeat();
        }

        function listenForCommands() {
            const appId = "sing-a-song-c80f1";
            const sessionRef = doc(db, `artifacts/${appId}/public/data/sessions`, sessionId);
            onSnapshot(sessionRef, (doc) => {
                if (!doc.exists()) return;
                const data = doc.data();
                if (data && data.command && data.command.commandId !== lastCommandId) {
                    lastCommandId = data.command.commandId;
                    handleCommand(data.command);
                }
            });
        }

        function handleCommand(command) {
            if (command.type === 'screen') {
                showScreen(command.screenId, command.taskContent);
            } else if (command.type === 'timer') {
                const currentScreenConfig = screenConfig[gameState.screenId];
                if (!currentScreenConfig) return;

                if (command.action === 'start') {
                    startMainTimer(currentScreenConfig.timerId, remainingSeconds > 0 ? remainingSeconds : currentScreenConfig.duration);
                } else if (command.action === 'stop') {
                    stopMainTimer();
                } else if (command.action === 'reset') {
                    resetMainTimer(currentScreenConfig.timerId, currentScreenConfig.duration);
                }
            }
        }

        function updateGameState(newState) {
            gameState = { ...gameState, ...newState };
            const appId = gameState.appId || 'sing-a-song-c80f1';
            if (db && sessionId) {
                const sessionRef = doc(db, `artifacts/${appId}/public/data/sessions`, sessionId);
                setDoc(sessionRef, { 
                    ...gameState,
                    lastUpdate: serverTimestamp()
                 }, { merge: true });
            }
        }

        function showScreen(screenId, taskContent = {}) {
            stopMainTimer();

            // FIX: Clear previous dynamic content to prevent duplicate element IDs
            ['silentReading', 'readAloud', 'challengeInstructions', 'singASong'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = ''; 
            });

            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            const screenEl = document.getElementById(screenId);
            if (screenEl) screenEl.classList.remove('hidden');

            if (screenId === 'complete' && sessionStartTime) {
                const endTime = new Date(sessionStartTime.getTime() + (2 * 60 * 60 * 1000)); // 2 hours
                const endTimeString = endTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                document.getElementById('endTimeDisplay').textContent = endTimeString;
            }

            if (['silentReading', 'readAloud', 'challengeInstructions', 'singASong'].includes(screenId)) {
                screenEl.innerHTML = buildTaskScreen(screenId, taskContent);
            }
            
            gameState.screenId = screenId;
            gameState.taskContent = taskContent;
            const currentScreenConfig = screenConfig[screenId];
            if (currentScreenConfig) {
                resetMainTimer(currentScreenConfig.timerId, currentScreenConfig.duration);
            } else {
                updateGameState({ timer: { running: false, value: '' } });
            }
        }

        function buildTaskScreen(screenId, content) {
            const timerId = screenConfig[screenId].timerId;
            const duration = screenConfig[screenId].duration;
            const timerDisplay = formatTime(duration);

            return `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">${content.title || ''}</h2>
                    <div class="text-8xl font-mono font-bold my-2 text-gray-800" id="${timerId}">${timerDisplay}</div>
                    <div class="passage-box">
                        <h3 class="text-2xl font-bold mb-4">${content.passageTitle || ''}</h3>
                        <div class="text-gray-700 space-y-4 whitespace-pre-wrap">${content.passageBody || ''}</div>
                    </div>
                </div>
            `;
        }

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function startMainTimer(timerId, duration) {
            clearInterval(mainTimer);
            remainingSeconds = duration;
            const timerElement = document.getElementById(timerId);
            
            updateGameState({ timer: { running: true, value: formatTime(remainingSeconds) } });

            mainTimer = setInterval(() => {
                remainingSeconds--;
                if(timerElement) timerElement.textContent = formatTime(remainingSeconds);
                updateGameState({ timer: { running: true, value: formatTime(remainingSeconds) } });

                if (remainingSeconds <= 0) {
                    stopMainTimer();
                }
            }, 1000);
        }

        function stopMainTimer() {
            clearInterval(mainTimer);
            if (gameState.timer) {
                updateGameState({ timer: { ...gameState.timer, running: false } });
            }
        }

        function resetMainTimer(timerId, duration) {
            stopMainTimer();
            remainingSeconds = duration;
            const timerElement = document.getElementById(timerId);
            if(timerElement) timerElement.textContent = formatTime(duration);
            updateGameState({ timer: { running: false, value: formatTime(duration) } });
        }

        function generateSessionId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }
    </script>
</body>
</html>
